<!DOCTYPE html>
<html>
<head>
  <style>
    .microapp-summary-container {
      display: flex;
      flex-direction: column;
      width: 340px;
    }

    .microapp-detail-container {
      margin-top: 16px;
      margin-left: 16px;
      height: 100vh;
      width: 50%;
      border: 1px solid black;
    }

    .microapp-global-container {
      display: flex;
      flex-direction: row;
    }

    .microapp-container {
      margin-top: 16px;
      border: 1px solid black;
    }

    iframe {
      border: none;
    }
  </style>
  <script src="https://unpkg.com/adaptivecards/dist/adaptivecards.min.js"></script>
  <script type="module">
    import h from 'https://cdn.skypack.dev/hyperscript'
    import Courier from 'https://cdn.skypack.dev/@workgrid/courier'

    /*
    We create an "instance" of a render so all items being rendered have access to the properties
    at the root of the microapp via a closure (https://developer.mozilla.org/en-US/docs/Web/JavaScript/Closures)
     */
    function createMicroappRenderer(summaryContainer, detailContainer, {companyCode, spaceId, userToken}) {
      const framesBySource = new WeakMap()
      const microappsBySource = new WeakMap()

      function renderMicroapp(microapp) {
      }

      return microapp => renderMicroapp(microapp)
    }

    globalThis.createMicroappRenderer = createMicroappRenderer
  </script>
</head>
<body>
<div id="output" class="microapp-global-container"></div>

<script type="module">
  // Configuration
  // ================================================================
  const WORKGRID_COMPANY_CODE = 'workgridsoftware.dev'
  const WORKGRID_SPACE_ID = '17dacf8d-ee8d-45ff-9d6b-f984e789c4e3'
  const WORKGRID_USER_TOKEN = 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImJmZWE5Y2I0LWVmNjMtNDVkOS1iZDVjLTE4ZTQ5ZTk5MWMzYyJ9.eyJ3b3JrZ3JpZF90ZW5hbnRfaWQiOiI3MWMwNTUwNS05YmM1LTRiNjgtODJiOS01YjM5YzVlYjY2NzEiLCJ3b3JrZ3JpZF9jb25uZWN0b3JfaWQiOiIyZjBhNGI3Zi04NmIxLTQ1NDctYjRhNi04ODAwNjRiNzg3NWMiLCJzY29wZSI6ImNvbS53b3JrZ3JpZC5hcGkvdXNlcmNsaWVudC5hbGwiLCJpYXQiOjE2NjkxMTU4OTYsImV4cCI6MTY2OTExOTQ5NiwiYXVkIjoiaHR0cHM6Ly93b3JrZ3JpZHNvZnR3YXJlLmRldi53b3JrZ3JpZC5jb20iLCJpc3MiOiJodHRwczovL3dvcmtncmlkc29mdHdhcmUuZGV2LndvcmtncmlkLmNvbSIsInN1YiI6Ijg0NDkyZjFkLWE1YjAtNGVhNi04YWM4LTNlYjdlNTE2M2Q1YiJ9.BV-uIhwLAwRjyJx2SpA9p4BQgIPUWqDGSATYrkKTwzHuWv-QFCPEu2y7UGLZ8r1iKrexoxmFRHquRRpPQqHEmRDQfGlS9MOaAzL5yN0_hGspu6hMIDDw12vFHY9fomrkVC5P9xqvRZSerUtl_qwku7vzGGX3rZG_KcoJW_rBg0xMPzsmFyWD5WM7uqnRGyFggEHTMc1-r3VaA99kuGJQhzfVo2vcdxhF--vwGdyNxGre0kFzWAm6yblgJ8I176OLpP9Syb25rf3VQqMpzXktQtYa6uuTUNdV1BvEAXBqdfaLCjEoKCCTcE_voYJAxtXBp6kcdUDWF4YJ4q6zwevW3g'

  // // Configuration
  // // ================================================================
  // const WORKGRID_COMPANY_CODE = '<company-code>'
  // const WORKGRID_SPACE_ID = '<space-id>'
  // const WORKGRID_USER_TOKEN = '<user-token>'

  // Libraries
  // ================================================================

  import h from 'https://cdn.skypack.dev/hyperscript'

  // Output
  // ================================================================

  const output = document.querySelector('#output')
  output.append(h('p', 'Loading...'))

  let microapps = await retrieveMicroapps()

  if (microapps?.length) {
    output.innerHTML = ''

    const summaryContainer = h('div.microapp-summary-container')
    output.append(summaryContainer)

    const detailContainer = h('div.microapp-detail-container', {id: 'detail-container'})
    output.append(detailContainer)

    const renderMicroapp = createMicroappRenderer(summaryContainer, detailContainer, {
      companyCode: WORKGRID_COMPANY_CODE,
      spaceId: WORKGRID_SPACE_ID,
      userToken: WORKGRID_USER_TOKEN
    })

    microapps.forEach(microapp => renderMicroapp(microapp))
  } else {
    output.append(h('h1', 'No microapps'))
  }

  async function retrieveMicroapps() {
    try {
      const response = await fetch(`https://${WORKGRID_COMPANY_CODE}.workgrid.com/v1/microapps`, {
        method: 'get',
        headers: {
          Authorization: `Bearer ${WORKGRID_USER_TOKEN}`,
          'x-workgrid-space': WORKGRID_SPACE_ID
        }
      })

      if (!response.ok) {
        throw new Error('Request was unsuccessful')
      }

      const data = await response.json()

      return data?.data?.apps
    } catch (error) {
      console.error(error)
      output.innerHTML = ``
      output.append(h('h1', 'Error'))
      output.append(h('pre', error.stack))
    }
  }
</script>
</body>
</html>
