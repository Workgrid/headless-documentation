<!DOCTYPE html>
<html>
<head>
  <style>
    .microapp-summary-container {
      display: flex;
      flex-direction: column;
      width: 340px;
    }

    .microapp-detail-container {
      margin-top: 16px;
      margin-left: 16px;
      height: 100vh;
      width: 50%;
      border: 1px solid black;
    }

    .microapp-global-container {
      display: flex;
      flex-direction: row;
    }

    .microapp-container {
      margin-top: 16px;
      border: 1px solid black;
    }

    iframe {
      border: none;
    }
  </style>
  <script type="module">
    import h from 'https://cdn.skypack.dev/hyperscript'
    import Courier from 'https://cdn.skypack.dev/@workgrid/courier'

    /*
    We create an "instance" of a render so all items being rendered have access to the properties
    at the root of the microapp via a closure (https://developer.mozilla.org/en-US/docs/Web/JavaScript/Closures)
     */
    function createMicroappRenderer(summaryContainer, detailContainer, {companyCode, spaceId, userToken}) {
      const framesBySource = new WeakMap()
      const microappsBySource = new WeakMap()

      function renderMicroapp(microapp) {
      }

      return microapp => renderMicroapp(microapp)
    }

    globalThis.createMicroappRenderer = createMicroappRenderer
  </script>
</head>
<body>
<div id="output" class="microapp-global-container"></div>

<script type="module">
  // Configuration
  // ================================================================
  const WORKGRID_COMPANY_CODE = '<company-code>'
  const WORKGRID_SPACE_ID = '<space-id>'
  const WORKGRID_USER_TOKEN = '<user-token>'

  // Libraries
  // ================================================================

  import h from 'https://cdn.skypack.dev/hyperscript'

  // Output
  // ================================================================

  const output = document.querySelector('#output')
  output.append(h('p', 'Loading...'))

  let microapps = await retrieveMicroapps()

  if (microapps?.length) {
    output.innerHTML = ''

    const summaryContainer = h('div.microapp-summary-container')
    output.append(summaryContainer)

    const detailContainer = h('div.microapp-detail-container', {id: 'detail-container'})
    output.append(detailContainer)

    const renderMicroapp = createMicroappRenderer(summaryContainer, detailContainer, {
      companyCode: WORKGRID_COMPANY_CODE,
      spaceId: WORKGRID_SPACE_ID,
      userToken: WORKGRID_USER_TOKEN
    })

    microapps.forEach(microapp => renderMicroapp(microapp))
  } else {
    output.append(h('h1', 'No microapps'))
  }

  async function retrieveMicroapps() {
    try {
      const response = await fetch(`https://${WORKGRID_COMPANY_CODE}.workgrid.com/v1/microapps`, {
        method: 'get',
        headers: {
          Authorization: `Bearer ${WORKGRID_USER_TOKEN}`,
          'x-workgrid-space': WORKGRID_SPACE_ID
        }
      })

      if (!response.ok) {
        throw new Error('Request was unsuccessful')
      }

      const data = await response.json()

      return data?.data?.apps
    } catch (error) {
      console.error(error)
      output.innerHTML = ``
      output.append(h('h1', 'Error'))
      output.append(h('pre', error.stack))
    }
  }
</script>
</body>
</html>
